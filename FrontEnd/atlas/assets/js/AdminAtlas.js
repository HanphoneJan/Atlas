import{d as e,u as a,r as l,x as t,k as o,a as s,b as u,e as r,w as n,h as i,F as d,o as c,j as p,y as m,i as v,t as f,H as b,E as y,I as w,G as V,_ as g}from"./index.js";import{E as h}from"./api.js";const _={class:"table-container"},k={class:"btn-group"},T=g(e({__name:"AdminAtlas",setup(e){const g=a(),T=l([]),C=l(!1),x=l(null),A=l(null);t((async()=>{try{const e=await o.get(h.ADMINSHOW,{headers:{Authorization:`Bearer ${g.token}`}});200===e.status?T.value=e.data.data:console.error("错误的数据结构:",e.data)}catch(e){console.error("获取图集数据失败:",e.message)}}));const E=async e=>{if(!e.inputValue)return e.inputValue="",void(e.inputVisible=!1);const a=e.inputValue.trim();if(""!==a){e.tags.push({id:Date.now(),name:a});try{const l=await o.post(h.ADDTAG,{filesId:e.id,tagName:a});e.inputValue="",e.inputVisible=!1,830===l.data.status?y.success("标签添加成功"):(e.tags.pop(),y.error("标签添加失败"))}catch(l){e.inputValue="",e.inputVisible=!1,e.tags.pop(),y.error("请求失败")}}},I=(e,a)=>Number(e.likes)-Number(a.likes),U=(e,a)=>Number(e.type)-Number(a.type),B=async()=>{if(x.value)try{const e=await o.post(h.ADMINUPDATE,x.value,{headers:{Authorization:`Bearer ${g.token}`}});if(830===e.data.status){const e=T.value.findIndex((e=>e.id===x.value.id));-1!==e&&(T.value[e]={...x.value}),C.value=!1,y.success("更新成功")}else console.error("图片数据更新失败:",e.data.message),y.error("更新失败")}catch(e){console.error("图片数据更新出错:",e.message),y.error("更新失败")}};return(e,a)=>{const l=i("el-image"),t=i("el-table-column"),z=i("el-switch"),D=i("el-tag"),N=i("el-input"),O=i("el-button"),H=i("el-table"),P=i("el-form-item"),G=i("el-form"),j=i("el-dialog");return c(),s(d,null,[u("div",_,[r(H,{data:T.value,class:"responsive-table",border:""},{default:n((()=>[r(t,{label:"图片"},{default:n((e=>[r(l,{src:e.row.path,class:"image-preview","preview-src-list":[e.row.path],"preview-teleported":""},null,8,["src","preview-src-list"])])),_:1}),r(t,{prop:"author",label:"作者",width:"90px",sortable:""}),r(t,{prop:"title",label:"标题"}),r(t,{prop:"description",label:"简介"}),r(t,{prop:"upload_time",label:"上传时间",sortable:""}),r(t,{prop:"likes",label:"点赞数",width:"100px",sortable:!0,"sort-method":I}),r(t,{label:"审核状态",width:"110px",sortable:!0,"sort-method":U},{default:n((({row:e})=>[r(z,{"model-value":e.type,"active-value":"1","inactive-value":"0",onChange:a=>(async(e,a)=>{const l=e.type;e.type=a;try{const{data:a}=await o.post(h.CHANGEPHOTOTYPE,{photo:e});830!==a.status?(e.type=l,y.error("审核失败")):y.success("审核成功")}catch(t){e.type=l,y.error("请求出错！服务器繁忙，请稍后再试。")}})(e,a)},null,8,["model-value","onChange"])])),_:1}),r(t,{label:"标签",prop:"tags"},{default:n((e=>[(c(!0),s(d,null,m(e.row.tags,((a,l)=>(c(),p(D,{size:"default",key:a.id,closable:"",onClose:a=>(async(e,a)=>{try{if("confirm"===await V.confirm("此操作将永久删除该标签, 是否继续","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})){const l=a.tags[e];830===(await o.post(h.DELETEPHOTOTAG,{filesId:a.id,tagId:l.id})).data.status?(a.tags.splice(e,1),y.success("标签删除成功")):y.error("标签删除失败")}else y.success("已取消删除")}catch(l){"cancel"!==l&&"close"!==l&&(console.error("删除标签失败：",l.message),y.error("删除失败"))}})(l,e.row)},{default:n((()=>[v(f(a.name),1)])),_:2},1032,["onClose"])))),128)),e.row.inputVisible?(c(),p(N,{key:0,size:"small",style:{width:"100px"},class:"input-new-tag",modelValue:e.row.inputValue,"onUpdate:modelValue":a=>e.row.inputValue=a,ref_key:"saveTagInput",ref:A,onKeyup:b((a=>E(e.row)),["enter"]),onBlur:a=>E(e.row)},null,8,["modelValue","onUpdate:modelValue","onKeyup","onBlur"])):(c(),p(O,{key:1,size:"small",class:"button-new-tag",onClick:a=>(e.row.inputVisible=!0,void w((()=>{A.value&&A.value.focus()})))},{default:n((()=>a[8]||(a[8]=[v(" + 新标签 ")]))),_:2},1032,["onClick"]))])),_:1}),r(t,{label:"操作"},{default:n((e=>[u("div",k,[r(O,{onClick:a=>(async e=>{x.value={...e},C.value=!0,await w()})(e.row),type:"primary",size:"small"},{default:n((()=>a[9]||(a[9]=[v("编辑")]))),_:2},1032,["onClick"]),r(O,{onClick:a=>(async e=>{try{if("confirm"===await V.confirm("此操作将永久删除该照片, 是否继续","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})){const a=await o.post(h.DELETEPHOTO,{fileId:e.id},{headers:{Authorization:`Bearer ${g.token}`}});830===a.data.status?(T.value=T.value.filter((a=>a.id!==e.id)),y.success("删除成功")):(console.error("删除图片失败:",a.data.message),y.error("删除失败"))}else y.info("已取消删除")}catch(a){"cancel"!==a&&"close"!==a&&(console.error("删除失败:",a.message),y.error("删除失败"))}})(e.row),type:"danger",size:"small"},{default:n((()=>a[10]||(a[10]=[v("删除")]))),_:2},1032,["onClick"])])])),_:1})])),_:1},8,["data"])]),r(j,{modelValue:C.value,"onUpdate:modelValue":a[7]||(a[7]=e=>C.value=e),title:"编辑图集项","destroy-on-close":""},{footer:n((()=>[r(O,{onClick:a[6]||(a[6]=e=>C.value=!1)},{default:n((()=>a[11]||(a[11]=[v("取消")]))),_:1}),r(O,{type:"primary",onClick:B},{default:n((()=>a[12]||(a[12]=[v("保存")]))),_:1})])),default:n((()=>[r(G,{model:x.value},{default:n((()=>[r(P,{label:"作者"},{default:n((()=>[r(N,{modelValue:x.value.author,"onUpdate:modelValue":a[0]||(a[0]=e=>x.value.author=e)},null,8,["modelValue"])])),_:1}),r(P,{label:"标题"},{default:n((()=>[r(N,{modelValue:x.value.title,"onUpdate:modelValue":a[1]||(a[1]=e=>x.value.title=e)},null,8,["modelValue"])])),_:1}),r(P,{label:"简介"},{default:n((()=>[r(N,{modelValue:x.value.description,"onUpdate:modelValue":a[2]||(a[2]=e=>x.value.description=e)},null,8,["modelValue"])])),_:1}),r(P,{label:"点赞量"},{default:n((()=>[r(N,{modelValue:x.value.likes,"onUpdate:modelValue":a[3]||(a[3]=e=>x.value.likes=e)},null,8,["modelValue"])])),_:1}),r(P,{label:"审核状态"},{default:n((()=>[r(N,{modelValue:x.value.type,"onUpdate:modelValue":a[4]||(a[4]=e=>x.value.type=e)},null,8,["modelValue"])])),_:1}),r(P,{label:"用户名"},{default:n((()=>[r(N,{modelValue:x.value.username,"onUpdate:modelValue":a[5]||(a[5]=e=>x.value.username=e)},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-7da6dbd0"]]);export{T as default};
